<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Lamaran Kerja - SIMGROUP</title>
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #D9ECF6; margin:0; padding:40px; }
      .container{ position:relative; max-width:700px; margin:-20px auto 0; background:#fff; padding:30px 40px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
      .container::before{content:"";position:absolute;top:0;left:0;height:10px;width:100%;border-top-left-radius:10px;border-top-right-radius:10px;background:#003366;}
      .header{text-align:center;margin-bottom:30px;}
      .header img{width:calc(100% + 80px);height:auto;display:block;margin:-20px 0 15px -40px;border-radius:0;}
      @media (max-width:600px){ .header img{width:100%;margin:0;} }
      .header h1{ font-size:33px;color:#333;margin:0;font-weight:700; }
      .header p{ font-size:14px;color:#666;margin-top:-2px; }

      .notice-wrapper { display:flex; align-items:flex-start; gap:10px; margin:20px 0 30px 0; }
      .notice-wrapper img{ width:80px; height:80px; object-fit:contain; border-radius:4px; margin-top:5px; }
      .notice { background:#fff8e5; border-left:4px solid #ffa500; padding:10px 15px; border-radius:6px; font-size:16px; color:#555; flex:1; text-align:justify; }

      label{ display:block; margin-top:20px; font-weight:600; color:#333; }
      input, select, textarea { width:100%; padding:10px 1px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; transition:border-color .3s; }
      input:focus, select:focus, textarea:focus { border-color:#0077cc; outline:none; }

      button { margin-top:30px; width:100%; padding:12px; background:#0077cc; color:#fff; font-weight:700; font-size:16px; border:none; border-radius:6px; cursor:pointer; transition:background-color .3s; }
      button:hover { background:#005fa3; }

      .modal { display:none; position:fixed; z-index:100; padding-top:120px; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); }
      .modal-content { width:80%; max-width:600px; margin:auto; padding:25px; border:1px solid #888; border-radius:10px; text-align:center; background:#fff; }
      .modal-content h2 { color:#0077cc; }
      .modal-content p { font-size:14px; color:#444; margin-top:10px; line-height:1.5; }
      .modal-content .ig-list { text-align:left; margin-top:15px; font-size:12px; }
      .modal-content .ig-list strong { display:inline-block; width:250px; }
      .close-btn { margin-top:20px; background:#0077cc; color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; }

      @media (max-width:600px) {
        .modal-content { width:95%; padding:20px; }
        .modal-content .ig-list strong { width:180px; }
        body { padding:20px; }
        .container { padding:15px; }
        label, input, select, textarea, button { font-size:14px; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <img src="https://res.cloudinary.com/djo0ewqoz/image/upload/v1746072866/WhatsApp_Image_2025-04-30_at_16.12.56_wgcbqt.jpg" alt="Logo">
        <h1>Form Lamaran Kerja - SIMGROUP</h1>
        <p>SIMGROUP adalah perusahaan penyedia dan pengelola tenaga kerja alih daya (outsourcing)<br>untuk berbagai sektor industri di Indonesia</p>
      </div>

      <div class="notice-wrapper">
        <div class="notice">
          Apabila Anda menemukan penipuan/pemungutan biaya yang mengatasnamakan PT Swakarya Insan Mandiri, bantu kami dengan melaporkannya ke Layanan Pengaduan SIMGROUP melalui Customer Service SIM:
          <a href="http://bit.ly/TiketSISKA" target="_blank">http://bit.ly/TiketSISKA</a>
        </div>
        <img src="https://res.cloudinary.com/djo0ewqoz/image/upload/c_crop,ar_9:16/v1749719941/WhatsApp_Image_2025-06-12_at_16.18.24_kom9gl.jpg" alt="Ikon">
      </div>

      <form id="dynamicForm">
        <label>Email Aktif</label>
        <input type="email" name="email" required>

        <label>Sumber Informasi Lowongan</label>
        <select name="sumber_informasi" required id="sumber_informasi">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Nama Lengkap (Sesuai KTP)</label>
        <input type="text" name="nama_lengkap" required>

        <label>Tanggal Lahir</label>
        <input type="date" name="tanggal_lahir" required>

        <label>Nomor WA Aktif</label>
        <input type="text" name="nomor_wa" required pattern="^0[0-9]{9,}$" title="Nomor WA harus dimulai dengan 0 dan diikuti oleh angka" placeholder="Contoh: 081234567890">

        <label>Nomor HP Aktif</label>
        <input type="text" name="nomor_hp" required pattern="^0[0-9]{9,}$" title="Nomor HP harus dimulai dengan 0 dan diikuti oleh angka" placeholder="Contoh: 081234567890">

        <label>Jenis Kelamin</label>
        <select name="jenis_kelamin" required>
          <option value="" disabled selected>-- Pilih --</option>
          <option value="Laki-Laki">Laki-Laki</option>
          <option value="Perempuan">Perempuan</option>
        </select>

        <label>Pengalaman Posisi Kerja Terakhir</label>
        <input type="text" name="pengalaman_kerja" required>

        <label>Durasi Pengalaman Kerja</label>
        <select name="durasi_pengalaman" required id="durasi_pengalaman">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Minat Posisi Kerja Pilihan Pertama</label>
        <input type="text" name="minat_posisi_1" list="minatList" placeholder="Silakan ketik atau pilih" required>
        <datalist id="minatList"></datalist>

        <label>Minat Posisi Kerja Pilihan Kedua</label>
        <input type="text" name="minat_posisi_2" list="minatList" placeholder="Silakan ketik atau pilih">
        <p style="font-size: 10px; color: red; margin-top: 3px; margin-bottom: -12px;">*Diisi jika ada</p>

        <label>Minat Posisi Kerja Pilihan Ketiga</label>
        <input type="text" name="minat_posisi_3" list="minatList" placeholder="Silakan ketik atau pilih">
        <p style="font-size: 10px; color: red; margin-top: 3px; margin-bottom: -12px;">*Diisi jika ada</p>

        <label>Pendidikan Terakhir</label>
        <select name="pendidikan_terakhir" required id="pendidikan_terakhir">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Nama Sekolah / Nama Universitas</label>
        <input type="text" name="nama_sekolah" list="universitasList" placeholder="Silakan ketik atau pilih" required>
        <datalist id="universitasList"></datalist>

        <label for="jurusanInput">Jurusan</label>
        <input type="text" id="jurusanInput" name="jurusan" list="jurusanList" placeholder="Silakan ketik atau pilih" required>
        <datalist id="jurusanList"></datalist>

        <label>Kepemilikan Kendaraan</label>
        <select name="kepemilikan_kendaraan" required id="kepemilikan_kendaraan">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Kepemilikan SIM Aktif</label>
        <select name="kepemilikan_sim" required id="kepemilikan_sim">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Alamat Domisili</label>
        <textarea name="alamat_domisili" required></textarea>

        <label>Kec. Domisili</label>
        <input type="text" name="kec._domisili" required>

        <label>Provinsi Domisili</label>
        <select name="provinsi_domisili" required id="provinsi_domisili">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <label>Upload CV (PDF)</label>
        <input type="file" name="upload_cv" accept="application/pdf" required>

        <label>Provinsi Minat Penempatan</label>
        <select name="provinsi_penempatan" required id="provinsi_penempatan">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <p style="font-size: 10px; color: red; margin-top: 3px; margin-bottom: -12px;">
          *Pilih Provinsi Penempatan agar dapat memilih Kota penempatan
        </p>

        <label>Kota Minat Penempatan</label>
        <select name="kota_penempatan" required id="kota_penempatan">
          <option value="" disabled selected>-- Pilih --</option>
        </select>

        <button type="submit">Kirim</button>
      </form>
    </div>

    <div id="successModal" class="modal">
      <div class="modal-content">
        <h2>Data berhasil dikirim!</h2>
        <p style="text-align: left;">Untuk Informasi Lowongan Kerja terbaru dapat diakses melalui Instagram Kami:</p>
        <div class="ig-list">
          <strong>Official Account</strong> @swamandiri @careersimgroup<br>
          <strong>Loker wilayah Bekasi</strong> @simgroupbekasi<br>
          <strong>Loker wilayah Jakarta</strong> @simgroupjakarta<br>
          <strong>Loker wilayah Bogor</strong> @simgroupbodebek<br>
          <strong>Loker wilayah Jawa Barat</strong> @simgroupjabar<br>
          <strong>Loker wilayah Jawa Tengah</strong> @simgroupjateng<br>
          <strong>Loker wilayah Jawa Timur</strong> @simgroupjawatimur<br>
          <strong>Loker wilayah Kalimantan</strong> @simgroupkalimantan<br>
          <strong>Loker wilayah Sumatera</strong> @simgroupsumbagut<br>
          <strong>Loker wilayah Sumatera</strong> @simgroupsumbagsel<br>
          <strong>Loker wilayah Sulawesi, Maluku & Papua</strong> @simgroupsulampapua<br>
          <strong>Loker wilayah Bali & Nusa Tenggara</strong> @simgroupbalinusra
        </div>
        <br>
        <p style="color: red; font-weight: bold;">
          ⚠️ <strong>Seluruh Proses Recruitment GRATIS tidak dipungut biaya apapun</strong> ⚠️
        </p>
        <button class="close-btn" onclick="closeModal()">Tutup</button>
      </div>
    </div>

    <script>
      /* CONFIG */
      const SPREADSHEET_ID = '1pvcbVAtI0IQgLlSItPz32pXB4QSQYgyq1TBbmEc14_k';
      const SHEET_MASTER = 'master';
      const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzuaujtZ-HRCNoFKAOGQf5ZwdPVU7Oz8JvZ2xztAwS_nQnhafOLoGM52irZPVU8iw08Pg/exec';

      // data structure
      const dropdownData = {
        sumberInformasi: [],      // col A (index 0)
        durasi: [],               // col B (index 1)
        minatPosisi: [],          // col D (index 3) -> datalist
        pendidikan: [],           // col E (index 4)
        kendaraan: [],            // col F (index 5)
        sim: [],                  // col G (index 6)
        provinsi: [],             // col H (index 7)
        provinsiKotaMap: {},      // provinsi -> [kota] (col I index 8)
        namaUniversitas: [],      // col J (index 9)
        jurusan: []               // col K (index 10)
      };

      // ambil sheet master via gviz/tq
      async function fetchMasterRows() {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_MASTER)}`;
        const res = await fetch(url);
        const txt = await res.text();
        const jsonStr = txt.replace(/^[^\(]*\(/, '').replace(/\);?\s*$/, '');
        const obj = JSON.parse(jsonStr);
        const table = obj.table;
        // map rows ke array fixed length (sampai kol K index 10)
        const rows = table.rows.map(r => {
          const cells = r.c || [];
          const out = [];
          for (let i = 0; i < 11; i++) {
            out.push(cells[i] && (cells[i].v !== undefined && cells[i].v !== null) ? String(cells[i].v).trim() : '');
          }
          return out;
        });
        return rows;
      }

      // helper unique & sort sesuai lokal id
      function uniqueSorted(arr) {
        return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> a.localeCompare(b, 'id'));
      }

      // populasi dropdown dari master, SKIP HEADER BARIS PERTAMA
      async function populateFromMaster_skipHeader() {
        try {
          const rows = await fetchMasterRows();
          if (!rows || rows.length === 0) return;

          // Skip baris pertama (header)
          const dataRows = rows.slice(1);

          dataRows.forEach(cols => {
            const colA = cols[0] || '';
            const colB = cols[1] || '';
            const colD = cols[3] || '';
            const colE = cols[4] || '';
            const colF = cols[5] || '';
            const colG = cols[6] || '';
            const colH = cols[7] || '';
            const colI = cols[8] || '';
            const colJ = cols[9] || '';
            const colK = cols[10] || '';

            if (colA) dropdownData.sumberInformasi.push(colA);
            if (colB) dropdownData.durasi.push(colB);
            if (colD) dropdownData.minatPosisi.push(colD);
            if (colE) dropdownData.pendidikan.push(colE);
            if (colF) dropdownData.kendaraan.push(colF);
            if (colG) dropdownData.sim.push(colG);
            if (colH) dropdownData.provinsi.push(colH);
            if (colJ) dropdownData.namaUniversitas.push(colJ);
            if (colK) dropdownData.jurusan.push(colK);

            if (colH && colI) {
              const prov = colH;
              const kota = colI;
              if (!dropdownData.provinsiKotaMap[prov]) dropdownData.provinsiKotaMap[prov] = [];
              dropdownData.provinsiKotaMap[prov].push(kota);
            }
          });

          // unique & sort
          dropdownData.sumberInformasi = uniqueSorted(dropdownData.sumberInformasi);
          dropdownData.durasi = uniqueSorted(dropdownData.durasi);
          dropdownData.minatPosisi = uniqueSorted(dropdownData.minatPosisi);
          dropdownData.pendidikan = uniqueSorted(dropdownData.pendidikan);
          dropdownData.kendaraan = uniqueSorted(dropdownData.kendaraan);
          dropdownData.sim = uniqueSorted(dropdownData.sim);
          dropdownData.provinsi = uniqueSorted(dropdownData.provinsi);
          dropdownData.namaUniversitas = uniqueSorted(dropdownData.namaUniversitas);
          dropdownData.jurusan = uniqueSorted(dropdownData.jurusan);
          for (const p in dropdownData.provinsiKotaMap) {
            dropdownData.provinsiKotaMap[p] = uniqueSorted(dropdownData.provinsiKotaMap[p]);
          }

          fillUI();
        } catch (err) {
          console.error('Gagal load master (skip-header):', err);
        }
      }

      // isi elemen UI dengan dropdownData
      function fillUI() {
        // sumber informasi
        const sumberEl = document.getElementById('sumber_informasi');
        dropdownData.sumberInformasi.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sumberEl.appendChild(o); });

        // durasi
        const durEl = document.getElementById('durasi_pengalaman');
        dropdownData.durasi.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; durEl.appendChild(o); });

        // pendidikan
        const pdEl = document.getElementById('pendidikan_terakhir');
        dropdownData.pendidikan.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; pdEl.appendChild(o); });

        // kendaraan
        const kndEl = document.getElementById('kepemilikan_kendaraan');
        dropdownData.kendaraan.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; kndEl.appendChild(o); });

        // sim
        const simEl = document.getElementById('kepemilikan_sim');
        dropdownData.sim.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; simEl.appendChild(o); });

        // provinsi (domisili & penempatan)
        const provDom = document.getElementById('provinsi_domisili');
        const provPen = document.getElementById('provinsi_penempatan');
        dropdownData.provinsi.forEach(v => {
          const o1 = document.createElement('option'); o1.value=v; o1.textContent=v; provDom.appendChild(o1);
          const o2 = document.createElement('option'); o2.value=v; o2.textContent=v; provPen.appendChild(o2);
        });

        // provinsi -> kota handler
        const kotaEl = document.getElementById('kota_penempatan');
        provPen.addEventListener('change', function() {
          kotaEl.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
          const p = this.value;
          const kotaList = dropdownData.provinsiKotaMap[p] || [];
          kotaList.forEach(k => { const o=document.createElement('option'); o.value=k; o.textContent=k; kotaEl.appendChild(o); });
        });

        // minat datalist
        const minatList = document.getElementById('minatList');
        dropdownData.minatPosisi.forEach(v => { const o=document.createElement('option'); o.value=v; minatList.appendChild(o); });

        // universitas datalist
        const univList = document.getElementById('universitasList');
        dropdownData.namaUniversitas.forEach(v => { const o=document.createElement('option'); o.value=v; univList.appendChild(o); });

        // jurusan datalist
        const jurList = document.getElementById('jurusanList');
        dropdownData.jurusan.forEach(v => { const o=document.createElement('option'); o.value=v; jurList.appendChild(o); });
      }

      // init: load master (skip header)
      window.addEventListener('load', populateFromMaster_skipHeader);

      /* ---------------------------
         FORM SUBMIT -> kirim ke Apps Script Web App
         --------------------------- */
      const form = document.getElementById('dynamicForm');
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitButton = form.querySelector('button');
        submitButton.disabled = true;
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Mengirim...';

        const fd = new FormData(form);

        // validasi file pdf
        const file = fd.get('upload_cv');
        if (!file || file.type !== 'application/pdf') {
          alert('Mohon upload file PDF.');
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
          return;
        }
        if (file.size > 2 * 1024 * 1024) {
          alert('Ukuran file maksimum 2MB.');
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
          return;
        }

        try {
          const fileBase64 = await toBase64(file);

          // collect fields except file
          const fields = {};
          form.querySelectorAll('input[name], select[name], textarea[name]').forEach(inp => {
            if (inp.name === 'upload_cv') return;
            fields[inp.name] = inp.value;
          });

          const payload = {
            timestamp: new Date().toISOString(),
            fields: fields,
            fileName: file.name,
            fileBase64: fileBase64.replace(/^data:application\/pdf;base64,/, '')
          };

          // <-- PERUBAHAN PENTING: kirim tanpa header Content-Type untuk menghindari preflight OPTIONS -->
          const resp = await fetch(BACKEND_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });

          const respText = await resp.text();
          // log response server (bagus untuk debugging)
          console.log('Server response:', resp.status, respText);

          if (!resp.ok) {
            throw new Error('Backend error: ' + resp.status + ' ' + respText);
          }

          form.reset();
          document.getElementById('successModal').style.display = 'block';
        } catch (err) {
          console.error(err);
          alert('Gagal mengirim data: ' + err.message);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      });

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function closeModal() {
        document.getElementById('successModal').style.display = 'none';
      }
    </script>
  </body>
</html>
